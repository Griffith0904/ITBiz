<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mabatis.org//DTD Mapper 3.0//EN"
                       "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="biz">
	<select id="getLastWeekPlaner" parameterType="hashmap" resultType="java.lang.String">
		<![CDATA[
			-- 전주 내역 조회시 해당 차주 - 1 해야함
			begin
				Declare
					@v_cnt int,
					@v_rtn_text nvarchar(max),
					@v_before_week int,
					@v_before_year int;
				Declare @v_table table (row_num int, bws_content nvarchar(max), bws_seq int);
			
				if #{week} = 1
					begin
						Set @v_before_week = 52;
						Set @v_before_year = #{year} - 1;
					end
				else
					begin
						Set @v_before_week = #{week} - 1;
						Set @v_before_year = #{year};
					end
						
				
				Select @v_cnt = Count(*)
				  From TB_USRBIZWK_MASTER with(nolock)
				 Where YEAR_NUM = @v_before_year
				   AND WEEK_NUM = @v_before_week
				   AND WORK_USER = #{userid};
			
				if @v_cnt = 0
					begin
						Set @v_rtn_text = '';
						Select @v_rtn_text;
						return;
					end
				else
					begin
					Select @v_cnt = Count(*)
					  From TB_USRBIZNW_DETAIL with(nolock)
					 WHERE YEAR_NUM = @v_before_year
					   AND WEEK_NUM = @v_before_week
					   AND WORK_USER = #{userid};
			
					if @v_cnt = 0
						begin
							Set @v_rtn_text = '';
							Select @v_rtn_text;
							return;
						end
			
					Insert Into @v_table
					SELECT
						Row_number() Over(order by A.SORT_NO, a.bws_seq) row_num, B.BWS_CONTENT, A.BWS_SEQ
					FROM
						TB_USRBIZNW_DETAIL A WITH(NOLOCK),
						TB_BIZWEEKLY_SUBJECT B WITH(NOLOCK)
					WHERE
						A.YEAR_NUM = @v_before_year AND
						A.WEEK_NUM = @v_before_week AND
						A.WORK_USER = #{userid} AND
						A.BWS_SEQ = B.BWS_SEQ
					Order by A.SORT_NO, A.BWS_SEQ;
			
					Select @v_cnt = Count(*) From @v_table;
				
					Declare
						@v_row int,
						@v_bws_seq int,
						@v_content_txt nvarchar(max),
						@v_all_content_txt nvarchar(max),
						@v_bws_content nvarchar(max);
			
					Set @v_row = 1;
			
					While @v_row <= @v_cnt
						begin
							Select @v_bws_seq = bws_seq, @v_bws_content = bws_content
							  From @v_table
							 Where row_num = @v_row;
			
							SELECT @v_content_txt = CONTENT_TXT
							  FROM TB_USRBIZNW_CONTENT WITH(NOLOCK)
							 WHERE YEAR_NUM = @v_before_year
							   AND WEEK_NUM = @v_before_week
							   AND WORK_USER = #{userid}
							   And BWS_SEQ = @v_bws_seq
							   And SC_SEQ = 1;
			
							if @v_row = 1
								begin
									set @v_all_content_txt = '◈ ' + @v_bws_content + char(13) + char(10) + @v_content_txt
								end
							else
								begin
									set @v_all_content_txt = @v_all_content_txt + char(13) + char(10) +  + char(13) + char(10) + '◈ ' + @v_bws_content + char(13) + char(10) + @v_content_txt;
								end
			
							Set @v_row = @v_row + 1;
						end
			
					select @v_all_content_txt; 
				end;
			end;
		]]>
	</select>
	
	<select id="getRegistedThisWorkSubject" parameterType="hashmap" resultType="kr.co.hojeon.beans.BizWeeklySubject" >
		<![CDATA[
			Select
				a.sort_no, a.bws_seq, b.bws_content, a.year_num, a.week_num, a.work_user, Row_number() Over(order by a.sort_no, a.bws_seq) rownum
			From
				TB_USRBIZTW_DETAIL a with(nolock),
				TB_BIZWEEKLY_SUBJECT b with(nolock)
			Where
				a.year_num = #{year} and
				a.week_num = #{week} and
				a.work_user = #{userid} and
				a.bws_seq = b.bws_seq
			Order by a.sort_no, a.bws_seq;
		]]>	
	</select>
	
	<select id="getRegistedNextWorkSubject" parameterType="hashmap" resultType="kr.co.hojeon.beans.BizWeeklySubject" >
		<![CDATA[
			Select
				a.sort_no, a.bws_seq, b.bws_content, a.year_num, a.week_num, a.work_user, Row_number() Over(order by a.sort_no, a.bws_seq) rownum
			From
				TB_USRBIZNW_DETAIL a with(nolock),
				TB_BIZWEEKLY_SUBJECT b with(nolock)
			Where
				a.year_num = #{year} and
				a.week_num = #{week} and
				a.work_user = #{userid} and
				a.bws_seq = b.bws_seq
			Order by a.sort_no, a.bws_seq;
		]]>	
	</select>

	<select id="getLastWeekPlaner2" parameterType="hashmap" resultType="java.lang.String">
		<![CDATA[
			begin
				Declare @v_cnt int;
				Declare @v_table table (row_num int, contents nvarchar(max));
				Declare @v_rtn_txt nvarchar(max);
				Declare @v_row_txt nvarchar(max);
				Declare @v_row int;
			
				Insert Into @v_table
				SELECT
					ROW_NUMBER() OVER(ORDER BY A.SORT_NO) ROW_NUM,
					CONCAT(C.BWS_CONTENT, char(13) , char(10) , B.CONTENT_TXT) CONTENTS
			
				FROM
					TB_USRBIZNW_DETAIL A WITH(NOLOCK),
					TB_USRBIZNW_CONTENT B WITH(NOLOCK),
					TB_BIZWEEKLY_SUBJECT C WITH(NOLOCK)
				WHERE
					A.YEAR_NUM = #{year} AND
					A.WEEK_NUM = #{week} AND
					A.WORK_USER = #{userid} AND
					A.YEAR_NUM = B.YEAR_NUM AND
					A.WEEK_NUM = B.WEEK_NUM AND
					A.WORK_USER = B.WORK_USER AND
					A.BWS_SEQ = B.BWS_SEQ AND
					A.BWS_SEQ = C.BWS_SEQ
				ORDER BY A.SORT_NO
				;
			
				Select @v_cnt = Count(*) From @v_table;
			
				if @v_cnt = 1
					begin
						Select @v_rtn_txt = CONTENTS From @v_table;
					End
				else if @v_cnt = 0
					begin
						Set @v_rtn_txt = '';
					end
				Else
					begin
						Set @v_row = 1;
					
						while @v_row <= @v_cnt
							begin
								Select @v_row_txt = CONTENTS
								  From @v_table
								 Where row_num = @v_row;
			
								if @v_row = 1
									begin
										Set @v_rtn_txt = @v_row_txt;
									end
								else
									begin
										Set @v_rtn_txt = @v_rtn_txt + char(13) + char(10) + @v_row_txt;
									end
			
								Set @v_row = @v_row + 1;
							end
					end
			
				Select @v_rtn_txt rtn_content;
			end;
		]]>		
	</select>
	
	<select id="getJustWeekBasicSubject" resultType="kr.co.hojeon.beans.BizWeeklyBasicSubject">
		<![CDATA[
			SELECT
				bws_seq, bws_content, remark, use_yn, just_me, sort_no, wk_date, wk_user, et_date, et_user, row_number() over(order by bws_seq) rownum
			From
				TB_BIZWEEKLY_SUBJECT with(nolock)
			Order by
				sort_no;
		]]>
	</select>
	
	<insert id="insertUsrBizWeeklyDataForThisWeek" parameterType='kr.co.hojeon.beans.TableUsrBizTwDetail' >
		<![CDATA[
			begin
				Declare @v_max_sort_no int;
			
				Select @v_max_sort_no = Max(sort_no)
				  From TB_USRBIZTW_DETAIL with(nolock)
				 Where year_num = #{year_num}
				   And week_num = #{week_num}
				   And work_user = #{work_user};
			
				if @v_max_sort_no is null
					begin
						Set @v_max_sort_no = 1;
					end
				else
					begin
						Set @v_max_sort_no = @v_max_sort_no + 1;
					end
			
				Insert into TB_USRBIZTW_DETAIL
					(
					year_num, week_num, work_user, bws_seq, sort_no, wk_date, wk_user
					)
				Values
					(
					#{year}, #{week}, #{userid}, #{bws_seq}, @v_max_sort_no, getdate(), #{wk_user}
					);
			
			end;
		]]>
	</insert>
</mapper>